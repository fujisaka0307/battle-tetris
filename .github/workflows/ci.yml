name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  # ---------------------------------------------------------------------------
  # Install — npm ci + node_modules cache save
  # ---------------------------------------------------------------------------
  install:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Restore node_modules cache
        id: cache-nm
        uses: actions/cache@v5
        with:
          path: node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.cache-nm.outputs.cache-hit != 'true'
        run: npm ci

  # ---------------------------------------------------------------------------
  # Lint
  # ---------------------------------------------------------------------------
  lint:
    runs-on: ubuntu-latest
    needs: install

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Restore node_modules cache
        uses: actions/cache/restore@v5
        with:
          path: node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          fail-on-cache-miss: true

      - name: Lint
        run: npx eslint . --max-warnings 0

  # ---------------------------------------------------------------------------
  # Build shared — produces shared-dist artifact
  # ---------------------------------------------------------------------------
  build-shared:
    runs-on: ubuntu-latest
    needs: install

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Restore node_modules cache
        uses: actions/cache/restore@v5
        with:
          path: node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          fail-on-cache-miss: true

      - name: Build shared
        run: npm run build -w shared

      - name: Upload shared dist
        uses: actions/upload-artifact@v6
        with:
          name: shared-dist
          path: shared/dist/
          retention-days: 1

  # ---------------------------------------------------------------------------
  # Typecheck — shared, client, server (sequential in one job)
  # ---------------------------------------------------------------------------
  typecheck:
    runs-on: ubuntu-latest
    needs: build-shared

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Restore node_modules cache
        uses: actions/cache/restore@v5
        with:
          path: node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          fail-on-cache-miss: true

      - name: Download shared dist
        uses: actions/download-artifact@v7
        with:
          name: shared-dist
          path: shared/dist/

      - name: Typecheck shared
        run: npm run typecheck -w shared

      - name: Typecheck client
        run: npm run typecheck -w client

      - name: Typecheck server
        run: npm run typecheck -w server

  # ---------------------------------------------------------------------------
  # Test shared — does not depend on shared build
  # ---------------------------------------------------------------------------
  test-shared:
    runs-on: ubuntu-latest
    needs: install

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Restore node_modules cache
        uses: actions/cache/restore@v5
        with:
          path: node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          fail-on-cache-miss: true

      - name: Test shared
        run: npm run test -w shared -- --coverage

      - name: Upload Allure results (unit-shared)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: allure-results-unit-shared
          path: allure-results/
          retention-days: 5
          if-no-files-found: warn

      - name: Upload coverage (shared)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: coverage-shared
          path: shared/coverage/lcov.info
          retention-days: 5
          if-no-files-found: warn

  # ---------------------------------------------------------------------------
  # Test client — needs shared dist
  # ---------------------------------------------------------------------------
  test-client:
    runs-on: ubuntu-latest
    needs: build-shared

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Restore node_modules cache
        uses: actions/cache/restore@v5
        with:
          path: node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          fail-on-cache-miss: true

      - name: Download shared dist
        uses: actions/download-artifact@v7
        with:
          name: shared-dist
          path: shared/dist/

      - name: Test client
        run: npm run test -w client -- --coverage

      - name: Upload Allure results (unit-client)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: allure-results-unit-client
          path: allure-results/
          retention-days: 5
          if-no-files-found: warn

      - name: Upload coverage (client)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: coverage-client
          path: client/coverage/lcov.info
          retention-days: 5
          if-no-files-found: warn

  # ---------------------------------------------------------------------------
  # Test server — needs shared dist
  # ---------------------------------------------------------------------------
  test-server:
    runs-on: ubuntu-latest
    needs: build-shared

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Restore node_modules cache
        uses: actions/cache/restore@v5
        with:
          path: node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          fail-on-cache-miss: true

      - name: Download shared dist
        uses: actions/download-artifact@v7
        with:
          name: shared-dist
          path: shared/dist/

      - name: Test server
        run: npm run test -w server -- --coverage

      - name: Upload Allure results (unit-server)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: allure-results-unit-server
          path: allure-results/
          retention-days: 5
          if-no-files-found: warn

      - name: Upload coverage (server)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: coverage-server
          path: server/coverage/lcov.info
          retention-days: 5
          if-no-files-found: warn

  # ---------------------------------------------------------------------------
  # Build client — needs shared dist
  # ---------------------------------------------------------------------------
  build-client:
    runs-on: ubuntu-latest
    needs: build-shared

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Restore node_modules cache
        uses: actions/cache/restore@v5
        with:
          path: node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          fail-on-cache-miss: true

      - name: Download shared dist
        uses: actions/download-artifact@v7
        with:
          name: shared-dist
          path: shared/dist/

      - name: Build client
        run: npm run build -w client
        env:
          VITE_SKIP_AUTH: 'true'

      - name: Upload client dist
        uses: actions/upload-artifact@v6
        with:
          name: client-dist
          path: client/dist/
          retention-days: 1

  # ---------------------------------------------------------------------------
  # Build server — needs shared dist
  # ---------------------------------------------------------------------------
  build-server:
    runs-on: ubuntu-latest
    needs: build-shared

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Restore node_modules cache
        uses: actions/cache/restore@v5
        with:
          path: node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          fail-on-cache-miss: true

      - name: Download shared dist
        uses: actions/download-artifact@v7
        with:
          name: shared-dist
          path: shared/dist/

      - name: Build server
        run: npm run build -w server

      - name: Upload server dist
        uses: actions/upload-artifact@v6
        with:
          name: server-dist
          path: server/dist/
          retention-days: 1

  # ---------------------------------------------------------------------------
  # npm audit — dependency vulnerability scanning
  # ---------------------------------------------------------------------------
  npm-audit:
    runs-on: ubuntu-latest
    needs: install

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Restore node_modules cache
        uses: actions/cache/restore@v5
        with:
          path: node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          fail-on-cache-miss: true

      - name: Run npm audit and generate Allure results
        run: node scripts/npm-audit-to-allure.mjs
        continue-on-error: true

      - name: Upload Allure results (npm audit)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: allure-results-npm-audit
          path: allure-results/
          retention-days: 5
          if-no-files-found: warn

  # ---------------------------------------------------------------------------
  # SonarCloud — code quality & coverage analysis
  # ---------------------------------------------------------------------------
  sonarcloud:
    runs-on: ubuntu-latest
    needs: [test-shared, test-client, test-server]

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Download coverage (shared)
        uses: actions/download-artifact@v7
        with:
          name: coverage-shared
          path: shared/coverage/

      - name: Download coverage (client)
        uses: actions/download-artifact@v7
        with:
          name: coverage-client
          path: client/coverage/

      - name: Download coverage (server)
        uses: actions/download-artifact@v7
        with:
          name: coverage-server
          path: server/coverage/

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}

      - name: Generate Allure results from SonarCloud
        run: node scripts/sonarcloud-to-allure.mjs
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}

      - name: Upload Allure results (SonarCloud)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: allure-results-sonarcloud
          path: allure-results/
          retention-days: 5
          if-no-files-found: warn

  # ---------------------------------------------------------------------------
  # Unified Allure Report — aggregates ALL quality & security results
  # ---------------------------------------------------------------------------
  allure-report:
    runs-on: ubuntu-latest
    needs:
      - lint
      - typecheck
      - test-shared
      - test-client
      - test-server
      - build-client
      - build-server
      - npm-audit
      - sonarcloud
    if: ${{ !cancelled() }}

    steps:
      - name: Download Allure results (unit-shared)
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          name: allure-results-unit-shared
          path: allure-results/

      - name: Download Allure results (unit-client)
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          name: allure-results-unit-client
          path: allure-results/

      - name: Download Allure results (unit-server)
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          name: allure-results-unit-server
          path: allure-results/

      - name: Download SonarCloud Allure results
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          name: allure-results-sonarcloud
          path: allure-results/

      - name: Download CodeQL Allure results
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          name: allure-results-codeql
          path: allure-results/

      - name: Download npm audit Allure results
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          name: allure-results-npm-audit
          path: allure-results/

      - name: Download Gitleaks Allure results
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          name: allure-results-gitleaks
          path: allure-results/

      - name: Flatten allure results
        run: |
          find allure-results -mindepth 2 -type f -exec mv {} allure-results/ \;
          find allure-results -mindepth 1 -type d -empty -delete

      - uses: actions/checkout@v6
        with:
          sparse-checkout: scripts
          path: repo

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Generate Security Dashboard summary
        run: node repo/scripts/security-summary-to-allure.mjs allure-results
        env:
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
          DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
          DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}

      - name: Load Allure report history
        uses: actions/checkout@v6
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Collect metrics for dashboard history
        run: |
          EXISTING=""
          if [ -f gh-pages/metrics-history.json ]; then
            EXISTING="gh-pages/metrics-history.json"
          fi
          node repo/scripts/collect-metrics.mjs allure-results "$EXISTING"

      - name: Generate Allure report
        uses: simple-elf/allure-report-action@v1.13
        with:
          allure_results: allure-results
          allure_report: allure-report
          gh_pages: gh-pages
          allure_history: allure-history

      - name: Fix allure-history permissions
        run: sudo chown -R $(whoami) allure-history || true

      - name: Include metrics history in published output
        run: cp metrics-history.json allure-history/metrics-history.json

      - name: Publish Allure report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
