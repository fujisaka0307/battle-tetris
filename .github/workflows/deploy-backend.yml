name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - 'server/**'
      - 'shared/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build shared
        run: npm run build -w shared

      - name: Build server
        run: npm run build -w server

      - name: Create deployment package
        run: |
          mkdir -p deploy

          # Copy server dist
          cp -r server/dist deploy/dist
          cp server/package.json deploy/

          # Copy shared package (workspace dependency)
          mkdir -p deploy/node_modules/@battle-tetris/shared
          cp -r shared/dist deploy/node_modules/@battle-tetris/shared/dist
          cp shared/package.json deploy/node_modules/@battle-tetris/shared/

          # Install production dependencies (excluding workspace deps)
          cd deploy
          npm install --omit=dev --ignore-scripts 2>/dev/null || true

          # Create zip
          zip -r ../server-deploy.zip .

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ vars.AZURE_APP_SERVICE_NAME }}
          publish-profile: ${{ secrets.AZURE_APP_SERVICE_PUBLISH_PROFILE }}
          package: server-deploy.zip

      - name: Configure Bedrock AI settings
        if: ${{ secrets.AWS_BEARER_TOKEN_BEDROCK != '' }}
        uses: azure/appservice-settings@v1
        with:
          app-name: ${{ vars.AZURE_APP_SERVICE_NAME }}
          publish-profile: ${{ secrets.AZURE_APP_SERVICE_PUBLISH_PROFILE }}
          app-settings-json: |
            [
              { "name": "AWS_BEARER_TOKEN_BEDROCK", "value": "${{ secrets.AWS_BEARER_TOKEN_BEDROCK }}", "slotSetting": false },
              { "name": "AWS_REGION", "value": "ap-northeast-1", "slotSetting": false }
            ]

      - name: Configure Grafana OTLP settings
        if: vars.GRAFANA_OTLP_ENDPOINT != ''
        uses: azure/appservice-settings@v1
        with:
          app-name: ${{ vars.AZURE_APP_SERVICE_NAME }}
          publish-profile: ${{ secrets.AZURE_APP_SERVICE_PUBLISH_PROFILE }}
          app-settings-json: |
            [
              { "name": "OTEL_EXPORTER_OTLP_ENDPOINT", "value": "${{ secrets.GRAFANA_OTLP_ENDPOINT }}" },
              { "name": "OTEL_EXPORTER_OTLP_HEADERS", "value": "Authorization=Basic ${{ secrets.GRAFANA_OTLP_AUTH_HEADER }}" },
              { "name": "LOG_LEVEL", "value": "info" }
            ]
