name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - 'server/**'
      - 'shared/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build shared
        run: npm run build -w shared

      - name: Build server
        run: npm run build -w server

      - name: Create deployment package
        run: |
          mkdir -p deploy

          # Copy server dist
          cp -r server/dist deploy/dist
          cp server/package.json deploy/

          # Copy shared package (workspace dependency)
          mkdir -p deploy/node_modules/@battle-tetris/shared
          cp -r shared/dist deploy/node_modules/@battle-tetris/shared/dist
          cp shared/package.json deploy/node_modules/@battle-tetris/shared/

          # Install production dependencies (excluding workspace deps)
          cd deploy
          npm install --omit=dev --ignore-scripts 2>/dev/null || true

          # Create zip
          zip -r ../server-deploy.zip .

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ vars.AZURE_APP_SERVICE_NAME }}
          publish-profile: ${{ secrets.AZURE_APP_SERVICE_PUBLISH_PROFILE }}
          package: server-deploy.zip

      - name: Configure App Settings via Kudu API
        env:
          PUBLISH_PROFILE: ${{ secrets.AZURE_APP_SERVICE_PUBLISH_PROFILE }}
          APP_NAME: ${{ vars.AZURE_APP_SERVICE_NAME }}
          BEDROCK_TOKEN: ${{ secrets.AWS_BEARER_TOKEN_BEDROCK }}
          GRAFANA_ENDPOINT: ${{ secrets.GRAFANA_OTLP_ENDPOINT }}
          GRAFANA_AUTH: ${{ secrets.GRAFANA_OTLP_AUTH_HEADER }}
        run: |
          # Extract SCM credentials from publish profile
          SCM_USER=$(echo "$PUBLISH_PROFILE" | grep -oP 'userName="\K[^"]+' | head -1)
          SCM_PASS=$(echo "$PUBLISH_PROFILE" | grep -oP 'userPWD="\K[^"]+' | head -1)

          # Build .env file content
          ENV_CONTENT="AWS_BEARER_TOKEN_BEDROCK=$BEDROCK_TOKEN"$'\n'
          ENV_CONTENT+="AWS_REGION=us-east-1"$'\n'

          if [ -n "$GRAFANA_ENDPOINT" ]; then
            ENV_CONTENT+="OTEL_EXPORTER_OTLP_ENDPOINT=$GRAFANA_ENDPOINT"$'\n'
            ENV_CONTENT+="OTEL_EXPORTER_OTLP_HEADERS=Authorization=Basic $GRAFANA_AUTH"$'\n'
            ENV_CONTENT+="LOG_LEVEL=info"$'\n'
          fi

          # Upload .env via Kudu VFS API
          curl -sf -X PUT \
            "https://$APP_NAME.scm.azurewebsites.net/api/vfs/site/wwwroot/.env" \
            -u "$SCM_USER:$SCM_PASS" \
            -H "If-Match: *" \
            -H "Content-Type: text/plain" \
            --data-raw "$ENV_CONTENT"

          echo ".env file deployed to App Service."
