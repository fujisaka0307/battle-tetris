import { TetrominoType } from '@battle-tetris/shared';

// =============================================================================
// Tetromino Shapes — 4x4 matrix, each rotation state
// =============================================================================

/**
 * 各テトリミノの4回転状態の形状定義。
 * 1 = ブロックあり, 0 = 空
 * index: 0=spawn(0°), 1=R(90°CW), 2=180°, 3=L(270°CW)
 */
export const SHAPES: Record<TetrominoType, number[][][]> = {
  [TetrominoType.I]: [
    [
      [0, 0, 0, 0],
      [1, 1, 1, 1],
      [0, 0, 0, 0],
      [0, 0, 0, 0],
    ],
    [
      [0, 0, 1, 0],
      [0, 0, 1, 0],
      [0, 0, 1, 0],
      [0, 0, 1, 0],
    ],
    [
      [0, 0, 0, 0],
      [0, 0, 0, 0],
      [1, 1, 1, 1],
      [0, 0, 0, 0],
    ],
    [
      [0, 1, 0, 0],
      [0, 1, 0, 0],
      [0, 1, 0, 0],
      [0, 1, 0, 0],
    ],
  ],
  [TetrominoType.O]: [
    [
      [0, 1, 1, 0],
      [0, 1, 1, 0],
      [0, 0, 0, 0],
      [0, 0, 0, 0],
    ],
    [
      [0, 1, 1, 0],
      [0, 1, 1, 0],
      [0, 0, 0, 0],
      [0, 0, 0, 0],
    ],
    [
      [0, 1, 1, 0],
      [0, 1, 1, 0],
      [0, 0, 0, 0],
      [0, 0, 0, 0],
    ],
    [
      [0, 1, 1, 0],
      [0, 1, 1, 0],
      [0, 0, 0, 0],
      [0, 0, 0, 0],
    ],
  ],
  [TetrominoType.T]: [
    [
      [0, 1, 0],
      [1, 1, 1],
      [0, 0, 0],
    ],
    [
      [0, 1, 0],
      [0, 1, 1],
      [0, 1, 0],
    ],
    [
      [0, 0, 0],
      [1, 1, 1],
      [0, 1, 0],
    ],
    [
      [0, 1, 0],
      [1, 1, 0],
      [0, 1, 0],
    ],
  ],
  [TetrominoType.S]: [
    [
      [0, 1, 1],
      [1, 1, 0],
      [0, 0, 0],
    ],
    [
      [0, 1, 0],
      [0, 1, 1],
      [0, 0, 1],
    ],
    [
      [0, 0, 0],
      [0, 1, 1],
      [1, 1, 0],
    ],
    [
      [1, 0, 0],
      [1, 1, 0],
      [0, 1, 0],
    ],
  ],
  [TetrominoType.Z]: [
    [
      [1, 1, 0],
      [0, 1, 1],
      [0, 0, 0],
    ],
    [
      [0, 0, 1],
      [0, 1, 1],
      [0, 1, 0],
    ],
    [
      [0, 0, 0],
      [1, 1, 0],
      [0, 1, 1],
    ],
    [
      [0, 1, 0],
      [1, 1, 0],
      [1, 0, 0],
    ],
  ],
  [TetrominoType.J]: [
    [
      [1, 0, 0],
      [1, 1, 1],
      [0, 0, 0],
    ],
    [
      [0, 1, 1],
      [0, 1, 0],
      [0, 1, 0],
    ],
    [
      [0, 0, 0],
      [1, 1, 1],
      [0, 0, 1],
    ],
    [
      [0, 1, 0],
      [0, 1, 0],
      [1, 1, 0],
    ],
  ],
  [TetrominoType.L]: [
    [
      [0, 0, 1],
      [1, 1, 1],
      [0, 0, 0],
    ],
    [
      [0, 1, 0],
      [0, 1, 0],
      [0, 1, 1],
    ],
    [
      [0, 0, 0],
      [1, 1, 1],
      [1, 0, 0],
    ],
    [
      [1, 1, 0],
      [0, 1, 0],
      [0, 1, 0],
    ],
  ],
};

// =============================================================================
// SRS Wall Kick Offset Data
// =============================================================================

/** [from][to] → [dx, dy][] のオフセット（dx=右が+, dy=上が+）※SRS標準座標系 */
type WallKickData = Record<string, [number, number][]>;

/**
 * J, L, S, T, Z ミノ用の壁キックデータ（SRS標準）
 * キー: "from>to" (e.g. "0>1" = 0°→R)
 * 座標系: dx=右が正, dy=上が正（SRS標準）
 * GameEngine側で row - dy として grid座標に変換する
 */
export const WALL_KICK_JLSTZ: WallKickData = {
  '0>1': [[0, 0], [-1, 0], [-1, 1], [0, -2], [-1, -2]],
  '1>0': [[0, 0], [1, 0], [1, -1], [0, 2], [1, 2]],
  '1>2': [[0, 0], [1, 0], [1, -1], [0, 2], [1, 2]],
  '2>1': [[0, 0], [-1, 0], [-1, 1], [0, -2], [-1, -2]],
  '2>3': [[0, 0], [1, 0], [1, 1], [0, -2], [1, -2]],
  '3>2': [[0, 0], [-1, 0], [-1, -1], [0, 2], [-1, 2]],
  '3>0': [[0, 0], [-1, 0], [-1, -1], [0, 2], [-1, 2]],
  '0>3': [[0, 0], [1, 0], [1, 1], [0, -2], [1, -2]],
};

/**
 * I ミノ用の壁キックデータ（SRS標準）
 * 座標系: dx=右が正, dy=上が正（SRS標準）
 */
export const WALL_KICK_I: WallKickData = {
  '0>1': [[0, 0], [-2, 0], [1, 0], [-2, -1], [1, 2]],
  '1>0': [[0, 0], [2, 0], [-1, 0], [2, 1], [-1, -2]],
  '1>2': [[0, 0], [-1, 0], [2, 0], [-1, 2], [2, -1]],
  '2>1': [[0, 0], [1, 0], [-2, 0], [1, -2], [-2, 1]],
  '2>3': [[0, 0], [2, 0], [-1, 0], [2, 1], [-1, -2]],
  '3>2': [[0, 0], [-2, 0], [1, 0], [-2, -1], [1, 2]],
  '3>0': [[0, 0], [1, 0], [-2, 0], [1, -2], [-2, 1]],
  '0>3': [[0, 0], [-1, 0], [2, 0], [-1, 2], [2, -1]],
};

// =============================================================================
// Color Mapping
// =============================================================================

/** テトリミノ種別 → CSS カラー */
export const TETROMINO_COLORS: Record<TetrominoType, string> = {
  [TetrominoType.I]: '#00f0f0', // cyan
  [TetrominoType.O]: '#f0f000', // yellow
  [TetrominoType.T]: '#a000f0', // purple
  [TetrominoType.S]: '#00f000', // green
  [TetrominoType.Z]: '#f00000', // red
  [TetrominoType.J]: '#0000f0', // blue
  [TetrominoType.L]: '#f0a000', // orange
};

// =============================================================================
// Utility
// =============================================================================

/** テトリミノの全種類リスト */
export const ALL_TETROMINO_TYPES: readonly TetrominoType[] = [
  TetrominoType.I,
  TetrominoType.O,
  TetrominoType.T,
  TetrominoType.S,
  TetrominoType.Z,
  TetrominoType.J,
  TetrominoType.L,
];

/** 回転状態数 */
export const ROTATION_COUNT = 4;

/**
 * 指定テトリミノ種別の壁キックデータを取得する。
 */
export function getWallKickData(type: TetrominoType): WallKickData {
  return type === TetrominoType.I ? WALL_KICK_I : WALL_KICK_JLSTZ;
}

/**
 * 回転後の状態indexを計算する。
 * @param current 現在の回転状態 (0-3)
 * @param delta +1 = CW, -1 = CCW
 */
export function nextRotation(current: number, delta: number): number {
  return ((current + delta) % ROTATION_COUNT + ROTATION_COUNT) % ROTATION_COUNT;
}

/**
 * テトリミノのスポーン位置（フィールド上部中央）を返す。
 * @returns [row, col] — バッファ行を含むフィールド上のrow
 */
export function getSpawnPosition(type: TetrominoType): [number, number] {
  const shape = SHAPES[type][0];
  const size = shape.length;
  // 横方向は中央揃え（4x4: col=3, 3x3: col=3）
  const col = Math.floor((10 - size) / 2);
  // 縦方向はバッファ行の上部（row=0がバッファ最上段）
  return [0, col];
}
